# PopupChatKit 功能点梳理

## 项目概述
PopupChatKit 是一个双模式 AI 对话系统,既可以作为独立 Web 应用运行,也可以作为轻量级插件嵌入到其他网站中。

---

## 核心功能模块

### 1. 独立模式 (Standalone Mode)

#### 1.1 AI 对话功能
- **基础对话**: 支持文本对话,流式返回响应
- **多模型支持**: 支持智谱AI和通义千问模型
- **API Key 配置**: 用户可自行填入 API Key
- **对话历史**: 持久化存储对话记录,支持查看历史会话

#### 1.2 AI 绘画功能
- **文生图**: 通过文本描述生成图片
- **参数配置**: 支持配置图片尺寸、风格等参数
- **历史记录**: 保存生成的图片和对应的提示词

#### 1.3 多媒体能力
- **图片上传**: 支持截图或上传图片进行分析
- **图片理解**: AI 解读图片内容
- **语音输入**: 支持语音转文字 (预留)

#### 1.4 MCP 集成 (预留)
- **工具调用**: 在对话中调用 MCP 协议工具
- **扩展能力**: 通过 MCP 扩展 AI 能力边界

---

### 2. 嵌入模式 (Embedded Mode)

#### 2.1 轻量级集成
- **JS 脚本注入**: 通过单个 JS 文件即可集成
- **最小侵入**: 不影响原网站样式和功能
- **独立样式**: 使用 Shadow DOM 隔离样式

#### 2.2 浮动弹窗
- **右侧悬浮**: 固定在页面右侧的圆形按钮
- **点击展开**: 展开为对话窗口
- **可拖拽**: 支持拖拽改变位置
- **最小化/关闭**: 支持最小化和关闭操作

#### 2.3 网页智能分析
- **页面总结**: 自动提取当前网页关键内容并总结
- **内容提取**: 提取网页文本、链接、图片等信息
- **结构化输出**: 将网页内容转换为 JSON 格式
- **智能问答**: 基于当前网页内容回答问题

#### 2.4 截图分析
- **网页截图**: 捕获当前网页或选定区域
- **图片分析**: AI 分析截图内容
- **OCR 识别**: 识别截图中的文字

---

## 技术功能点

### 3. 用户管理
- **会话管理**: 基于本地存储的会话标识
- **配置保存**: API Key 等配置信息加密存储
- **多会话支持**: 支持创建多个独立会话

### 4. 数据管理
- **SQLite 存储**: 使用 SQLite 存储对话历史
- **原生 SQL**: 直接使用 SQL 语句操作数据库
- **数据导出**: 支持导出对话记录为 JSON/Markdown

### 5. 界面交互
- **响应式设计**: 适配桌面和移动端
- **实时流式输出**: 打字机效果显示 AI 回复
- **Markdown 渲染**: 支持 Markdown 格式渲染
- **代码高亮**: 代码块语法高亮

---

## 页面结构

### 独立模式页面
1. **首页 (index.html)**: 欢迎页面,配置 API Key
2. **对话页面 (chat.html)**: 主对话界面
3. **历史记录页面 (history.html)**: 查看历史对话
4. **绘画页面 (draw.html)**: AI 绘画功能
5. **设置页面 (settings.html)**: 系统设置和配置
6. **关于页面 (about.html)**: 项目介绍和使用说明

### 嵌入模式页面
1. **弹窗界面 (popup.html)**: 嵌入式弹窗对话界面
2. **演示页面 (demo.html)**: 嵌入模式演示页面

---

## 技术栈

### 前端
- **HTML5**: 页面结构
- **CSS3**: 样式设计
- **Vanilla JavaScript**: 交互逻辑,无框架依赖
- **Markdown-it**: Markdown 渲染
- **highlight.js**: 代码高亮

### 后端
- **Python 3.10+**: 后端语言
- **FastAPI**: Web 框架
- **pydantic-ai**: LLM 交互
- **SQLite**: 数据存储
- **uvicorn**: ASGI 服务器
- **uv**: 包管理工具

### AI 模型
- **智谱AI (GLM-4)**: 主要对话模型
- **通义千问 (Qwen)**: 备用对话模型

---

## 数据库设计

### 表结构
```sql
-- 对话历史表
CREATE TABLE messages (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    session_id TEXT NOT NULL,
    message_list TEXT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 会话表
CREATE TABLE sessions (
    id TEXT PRIMARY KEY,
    title TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 用户配置表
CREATE TABLE user_config (
    key TEXT PRIMARY KEY,
    value TEXT NOT NULL,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 绘画历史表 (预留)
CREATE TABLE draw_history (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    prompt TEXT NOT NULL,
    image_url TEXT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

---

## 开发优先级

### P0 (核心功能)
- [x] 项目结构搭建
- [ ] 基础对话功能
- [ ] 对话历史存储
- [ ] API Key 配置

### P1 (重要功能)
- [ ] 嵌入模式实现
- [ ] 网页内容提取
- [ ] 图片上传与分析
- [ ] 流式响应

### P2 (增强功能)
- [ ] AI 绘画
- [ ] JSON 结构化输出
- [ ] 多会话管理
- [ ] 数据导出

### P3 (预留功能)
- [ ] MCP 协议集成
- [ ] 语音输入
- [ ] 多语言支持
- [ ] 插件系统

---

## 项目里程碑

- **Week 1**: 完成项目基础架构和核心对话功能
- **Week 2**: 实现嵌入模式和网页分析功能
- **Week 3**: 完成图片分析和绘画功能
- **Week 4**: 测试优化和文档完善

---

最后更新: 2025-10-28
