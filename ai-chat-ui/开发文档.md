# PopupChatKit å¼€å‘æ–‡æ¡£

## é¡¹ç›®ä¿¡æ¯

- **é¡¹ç›®åç§°**: PopupChatKit
- **ç‰ˆæœ¬**: v1.0.0
- **åˆ›å»ºæ—¥æœŸ**: 2025-10-28
- **æŠ€æœ¯è´Ÿè´£äºº**: Colin

---

## æŠ€æœ¯æ¶æ„

### æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Frontend (HTML5 + JS)         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Standalone â”‚  â”‚  Embedded Mode   â”‚  â”‚
â”‚  â”‚    Mode     â”‚  â”‚  (popup.js)      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â”‚                  â”‚            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                  â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚ HTTP/WS
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  FastAPI Server  â”‚
          â”‚   (Python)       â”‚
          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
          â”‚  pydantic-ai     â”‚
          â”‚  â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â” â”‚
          â”‚  â”‚ GLM â”‚ â”‚Qwen â”‚ â”‚
          â”‚  â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜ â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  SQLite Database â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æŠ€æœ¯é€‰å‹è¯´æ˜

### å‰ç«¯æŠ€æœ¯

#### HTML5
- è¯­ä¹‰åŒ–æ ‡ç­¾æå‡å¯è®¿é—®æ€§
- åŸç”ŸåŠŸèƒ½,æ— ä¾èµ–,åŠ è½½å¿«é€Ÿ
- é€‚åˆåµŒå…¥å¼åœºæ™¯

#### Vanilla JavaScript
- **é€‰æ‹©åŸå› **: 
  - æ— æ¡†æ¶ä¾èµ–,æ‰“åŒ…ä½“ç§¯å°
  - é€‚åˆåµŒå…¥å…¶ä»–ç½‘ç«™,é¿å…å†²çª
  - æ€§èƒ½ä¼˜ç§€,å¯åŠ¨å¿«é€Ÿ
- **æ¨¡å—åŒ–**: ä½¿ç”¨ ES6 æ¨¡å—åŒ–
- **å…¼å®¹æ€§**: æ”¯æŒç°ä»£æµè§ˆå™¨ (Chrome 90+, Firefox 88+, Safari 14+)

#### CSS3
- **æ ·å¼éš”ç¦»**: åµŒå…¥æ¨¡å¼ä½¿ç”¨ Shadow DOM
- **å“åº”å¼**: Flexbox + Grid å¸ƒå±€
- **ä¸»é¢˜ç³»ç»Ÿ**: CSS Variables å®ç°ä¸»é¢˜åˆ‡æ¢

### åç«¯æŠ€æœ¯

#### FastAPI
- **å¼‚æ­¥æ”¯æŒ**: åŸç”Ÿ async/await
- **ç±»å‹å®‰å…¨**: Pydantic æ¨¡å‹éªŒè¯
- **è‡ªåŠ¨æ–‡æ¡£**: OpenAPI/Swagger
- **æ€§èƒ½ä¼˜ç§€**: åŸºäº Starlette å’Œ Uvicorn

#### pydantic-ai
- **ç»Ÿä¸€æ¥å£**: æŠ½è±¡ä¸åŒ LLM æä¾›å•†
- **ç±»å‹å®‰å…¨**: å¼ºç±»å‹æ”¯æŒ
- **æµå¼è¾“å‡º**: æ”¯æŒ SSE æµå¼å“åº”
- **æ¶ˆæ¯å†å²**: å†…ç½®å¯¹è¯å†å²ç®¡ç†

#### SQLite
- **é›¶é…ç½®**: æ— éœ€ç‹¬ç«‹æ•°æ®åº“æœåŠ¡
- **è½»é‡çº§**: é€‚åˆä¸ªäººå’Œå°å‹é¡¹ç›®
- **å¯é æ€§**: äº‹åŠ¡æ”¯æŒ,æ•°æ®æŒä¹…åŒ–
- **å¯ç§»æ¤**: å•æ–‡ä»¶æ•°æ®åº“

---

## é¡¹ç›®ç»“æ„

```
PopupChatKit/
â”œâ”€â”€ backend/                    # åç«¯ä»£ç 
â”‚   â”œâ”€â”€ main.py                # FastAPI ä¸»åº”ç”¨
â”‚   â”œâ”€â”€ database.py            # æ•°æ®åº“æ“ä½œ
â”‚   â”œâ”€â”€ models.py              # Pydantic æ¨¡å‹
â”‚   â”œâ”€â”€ agents.py              # AI Agent é…ç½®
â”‚   â”œâ”€â”€ routers/               # API è·¯ç”±
â”‚   â”‚   â”œâ”€â”€ chat.py           # å¯¹è¯ç›¸å…³ API
â”‚   â”‚   â”œâ”€â”€ draw.py           # ç»˜ç”»ç›¸å…³ API
â”‚   â”‚   â”œâ”€â”€ history.py        # å†å²è®°å½• API
â”‚   â”‚   â””â”€â”€ config.py         # é…ç½®ç®¡ç† API
â”‚   â”œâ”€â”€ utils/                 # å·¥å…·å‡½æ•°
â”‚   â”‚   â”œâ”€â”€ web_extractor.py  # ç½‘é¡µå†…å®¹æå–
â”‚   â”‚   â””â”€â”€ image_handler.py  # å›¾ç‰‡å¤„ç†
â”‚   â”œâ”€â”€ init_db.sql            # æ•°æ®åº“åˆå§‹åŒ– SQL
â”‚   â””â”€â”€ pyproject.toml         # é¡¹ç›®ä¾èµ–é…ç½®
â”‚
â”œâ”€â”€ frontend/                   # å‰ç«¯ä»£ç 
â”‚   â”œâ”€â”€ standalone/            # ç‹¬ç«‹æ¨¡å¼
â”‚   â”‚   â”œâ”€â”€ index.html        # é¦–é¡µ/é…ç½®é¡µ
â”‚   â”‚   â”œâ”€â”€ chat.html         # å¯¹è¯é¡µé¢
â”‚   â”‚   â”œâ”€â”€ history.html      # å†å²è®°å½•é¡µ
â”‚   â”‚   â”œâ”€â”€ draw.html         # ç»˜ç”»é¡µé¢
â”‚   â”‚   â”œâ”€â”€ settings.html     # è®¾ç½®é¡µé¢
â”‚   â”‚   â”œâ”€â”€ about.html        # å…³äºé¡µé¢
â”‚   â”‚   â”œâ”€â”€ css/
â”‚   â”‚   â”‚   â”œâ”€â”€ common.css    # å…¬å…±æ ·å¼
â”‚   â”‚   â”‚   â”œâ”€â”€ chat.css      # å¯¹è¯é¡µé¢æ ·å¼
â”‚   â”‚   â”‚   â””â”€â”€ theme.css     # ä¸»é¢˜å˜é‡
â”‚   â”‚   â””â”€â”€ js/
â”‚   â”‚       â”œâ”€â”€ api.js        # API è°ƒç”¨å°è£…
â”‚   â”‚       â”œâ”€â”€ chat.js       # å¯¹è¯é€»è¾‘
â”‚   â”‚       â”œâ”€â”€ history.js    # å†å²è®°å½•é€»è¾‘
â”‚   â”‚       â”œâ”€â”€ config.js     # é…ç½®ç®¡ç†
â”‚   â”‚       â””â”€â”€ utils.js      # å·¥å…·å‡½æ•°
â”‚   â”‚
â”‚   â”œâ”€â”€ embedded/              # åµŒå…¥æ¨¡å¼
â”‚   â”‚   â”œâ”€â”€ popup.js          # åµŒå…¥è„šæœ¬ (æ ¸å¿ƒ)
â”‚   â”‚   â”œâ”€â”€ popup.css         # å¼¹çª—æ ·å¼
â”‚   â”‚   â””â”€â”€ demo.html         # æ¼”ç¤ºé¡µé¢
â”‚   â”‚
â”‚   â””â”€â”€ lib/                   # ç¬¬ä¸‰æ–¹åº“
â”‚       â”œâ”€â”€ markdown-it.min.js
â”‚       â””â”€â”€ highlight.min.js
â”‚
â”œâ”€â”€ ai-chat-ui/                # UI åŸå‹å’Œæ–‡æ¡£
â”‚   â”œâ”€â”€ åŠŸèƒ½ç‚¹æ¢³ç†.md
â”‚   â”œâ”€â”€ å¼€å‘æ–‡æ¡£.md
â”‚   â””â”€â”€ index.html            # UI åŸå‹å±•ç¤º
â”‚
â”œâ”€â”€ data/                      # æ•°æ®æ–‡ä»¶
â”‚   â””â”€â”€ chat.db               # SQLite æ•°æ®åº“
â”‚
â””â”€â”€ README.md                  # é¡¹ç›®è¯´æ˜
```

---

## æ•°æ®åº“è®¾è®¡

### DDL è¯­å¥

```sql
-- åˆå§‹åŒ–æ•°æ®åº“è„šæœ¬
-- æ–‡ä»¶ä½ç½®: backend/init_db.sql

-- ä¼šè¯è¡¨
CREATE TABLE IF NOT EXISTS sessions (
    id TEXT PRIMARY KEY,              -- UUID æ ¼å¼çš„ä¼šè¯ ID
    title TEXT NOT NULL,              -- ä¼šè¯æ ‡é¢˜
    mode TEXT DEFAULT 'standalone',   -- æ¨¡å¼: standalone/embedded
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_sessions_created ON sessions(created_at DESC);

-- æ¶ˆæ¯è¡¨
CREATE TABLE IF NOT EXISTS messages (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    session_id TEXT NOT NULL,         -- å…³è”ä¼šè¯ ID
    message_list TEXT NOT NULL,       -- JSON æ ¼å¼çš„æ¶ˆæ¯åˆ—è¡¨
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (session_id) REFERENCES sessions(id) ON DELETE CASCADE
);

CREATE INDEX idx_messages_session ON messages(session_id);
CREATE INDEX idx_messages_created ON messages(created_at DESC);

-- ç”¨æˆ·é…ç½®è¡¨
CREATE TABLE IF NOT EXISTS user_config (
    key TEXT PRIMARY KEY,             -- é…ç½®é”®
    value TEXT NOT NULL,              -- é…ç½®å€¼ (åŠ å¯†å­˜å‚¨)
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ç»˜ç”»å†å²è¡¨
CREATE TABLE IF NOT EXISTS draw_history (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    prompt TEXT NOT NULL,             -- ç»˜ç”»æç¤ºè¯
    negative_prompt TEXT,             -- è´Ÿé¢æç¤ºè¯
    image_url TEXT NOT NULL,          -- å›¾ç‰‡ URL
    model TEXT,                       -- ä½¿ç”¨çš„æ¨¡å‹
    parameters TEXT,                  -- JSON æ ¼å¼çš„å‚æ•°
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_draw_created ON draw_history(created_at DESC);

-- ç½‘é¡µåˆ†æç¼“å­˜è¡¨ (å¯é€‰)
CREATE TABLE IF NOT EXISTS web_cache (
    url TEXT PRIMARY KEY,             -- ç½‘é¡µ URL
    content TEXT NOT NULL,            -- æå–çš„å†…å®¹
    summary TEXT,                     -- AI æ€»ç»“
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    expires_at TIMESTAMP              -- è¿‡æœŸæ—¶é—´
);

CREATE INDEX idx_web_cache_expires ON web_cache(expires_at);
```

### æ•°æ®åº“æ“ä½œå°è£…

```python
# backend/database.py

import asyncio
import json
import sqlite3
from collections.abc import AsyncIterator, Callable
from concurrent.futures.thread import ThreadPoolExecutor
from contextlib import asynccontextmanager
from dataclasses import dataclass
from functools import partial
from pathlib import Path
from typing import Any, TypeVar

from pydantic_ai import ModelMessage, ModelMessagesTypeAdapter
from typing_extensions import LiteralString, ParamSpec

P = ParamSpec('P')
R = TypeVar('R')

@dataclass
class Database:
    """æ•°æ®åº“æ“ä½œç±»"""
    
    con: sqlite3.Connection
    _loop: asyncio.AbstractEventLoop
    _executor: ThreadPoolExecutor

    @classmethod
    @asynccontextmanager
    async def connect(cls, file: Path) -> AsyncIterator['Database']:
        """è¿æ¥æ•°æ®åº“"""
        loop = asyncio.get_event_loop()
        executor = ThreadPoolExecutor(max_workers=1)
        con = await loop.run_in_executor(executor, cls._connect, file)
        slf = cls(con, loop, executor)
        try:
            yield slf
        finally:
            await slf._asyncify(con.close)

    @staticmethod
    def _connect(file: Path) -> sqlite3.Connection:
        """å»ºç«‹æ•°æ®åº“è¿æ¥å¹¶åˆå§‹åŒ–"""
        con = sqlite3.connect(str(file))
        # è¯»å– init_db.sql å¹¶æ‰§è¡Œ
        init_sql = (Path(__file__).parent / 'init_db.sql').read_text()
        con.executescript(init_sql)
        con.commit()
        return con

    async def add_messages(self, session_id: str, messages: bytes):
        """æ·»åŠ æ¶ˆæ¯åˆ°æ•°æ®åº“"""
        await self._asyncify(
            self._execute,
            'INSERT INTO messages (session_id, message_list) VALUES (?, ?);',
            session_id, messages,
            commit=True
        )

    async def get_messages(self, session_id: str) -> list[ModelMessage]:
        """è·å–ä¼šè¯çš„æ‰€æœ‰æ¶ˆæ¯"""
        c = await self._asyncify(
            self._execute, 
            'SELECT message_list FROM messages WHERE session_id = ? ORDER BY id',
            session_id
        )
        rows = await self._asyncify(c.fetchall)
        messages: list[ModelMessage] = []
        for row in rows:
            messages.extend(ModelMessagesTypeAdapter.validate_json(row[0]))
        return messages

    async def create_session(self, session_id: str, title: str, mode: str = 'standalone'):
        """åˆ›å»ºæ–°ä¼šè¯"""
        await self._asyncify(
            self._execute,
            'INSERT INTO sessions (id, title, mode) VALUES (?, ?, ?);',
            session_id, title, mode,
            commit=True
        )

    async def get_sessions(self, limit: int = 50) -> list[dict]:
        """è·å–ä¼šè¯åˆ—è¡¨"""
        c = await self._asyncify(
            self._execute,
            'SELECT id, title, mode, created_at, updated_at FROM sessions ORDER BY updated_at DESC LIMIT ?',
            limit
        )
        rows = await self._asyncify(c.fetchall)
        return [
            {
                'id': row[0],
                'title': row[1],
                'mode': row[2],
                'created_at': row[3],
                'updated_at': row[4]
            }
            for row in rows
        ]

    async def update_session(self, session_id: str, title: str = None):
        """æ›´æ–°ä¼šè¯ä¿¡æ¯"""
        if title:
            await self._asyncify(
                self._execute,
                'UPDATE sessions SET title = ?, updated_at = CURRENT_TIMESTAMP WHERE id = ?',
                title, session_id,
                commit=True
            )
        else:
            await self._asyncify(
                self._execute,
                'UPDATE sessions SET updated_at = CURRENT_TIMESTAMP WHERE id = ?',
                session_id,
                commit=True
            )

    async def delete_session(self, session_id: str):
        """åˆ é™¤ä¼šè¯åŠå…¶æ¶ˆæ¯"""
        await self._asyncify(
            self._execute,
            'DELETE FROM sessions WHERE id = ?',
            session_id,
            commit=True
        )

    async def save_config(self, key: str, value: str):
        """ä¿å­˜é…ç½®"""
        await self._asyncify(
            self._execute,
            'INSERT OR REPLACE INTO user_config (key, value) VALUES (?, ?)',
            key, value,
            commit=True
        )

    async def get_config(self, key: str) -> str | None:
        """è·å–é…ç½®"""
        c = await self._asyncify(
            self._execute,
            'SELECT value FROM user_config WHERE key = ?',
            key
        )
        row = await self._asyncify(c.fetchone)
        return row[0] if row else None

    def _execute(
        self, sql: LiteralString, *args: Any, commit: bool = False
    ) -> sqlite3.Cursor:
        """æ‰§è¡Œ SQL"""
        cur = self.con.cursor()
        cur.execute(sql, args)
        if commit:
            self.con.commit()
        return cur

    async def _asyncify(
        self, func: Callable[P, R], *args: P.args, **kwargs: P.kwargs
    ) -> R:
        """å¼‚æ­¥æ‰§è¡ŒåŒæ­¥å‡½æ•°"""
        return await self._loop.run_in_executor(
            self._executor,
            partial(func, **kwargs),
            *args,
        )
```

---

## API è®¾è®¡

### RESTful API æ¥å£

#### 1. å¯¹è¯ç›¸å…³

```
POST   /api/chat/message          # å‘é€æ¶ˆæ¯
GET    /api/chat/history          # è·å–å†å²æ¶ˆæ¯
POST   /api/chat/stream           # æµå¼å¯¹è¯
DELETE /api/chat/session/{id}    # åˆ é™¤ä¼šè¯
```

#### 2. ä¼šè¯ç®¡ç†

```
GET    /api/sessions              # è·å–ä¼šè¯åˆ—è¡¨
POST   /api/sessions              # åˆ›å»ºä¼šè¯
PUT    /api/sessions/{id}         # æ›´æ–°ä¼šè¯
DELETE /api/sessions/{id}         # åˆ é™¤ä¼šè¯
```

#### 3. é…ç½®ç®¡ç†

```
GET    /api/config                # è·å–é…ç½®
POST   /api/config                # ä¿å­˜é…ç½®
POST   /api/config/validate       # éªŒè¯ API Key
```

#### 4. ç½‘é¡µåˆ†æ

```
POST   /api/web/extract           # æå–ç½‘é¡µå†…å®¹
POST   /api/web/summarize         # æ€»ç»“ç½‘é¡µ
POST   /api/web/to-json           # è½¬æ¢ä¸º JSON
```

#### 5. å›¾ç‰‡ç›¸å…³

```
POST   /api/image/upload          # ä¸Šä¼ å›¾ç‰‡
POST   /api/image/analyze         # åˆ†æå›¾ç‰‡
POST   /api/draw                  # AI ç»˜ç”»
GET    /api/draw/history          # ç»˜ç”»å†å²
```

### API è¯¦ç»†è®¾è®¡

#### POST /api/chat/stream

**è¯·æ±‚ä½“:**
```json
{
  "session_id": "uuid-string",
  "message": "ç”¨æˆ·æ¶ˆæ¯å†…å®¹",
  "model": "zhipu",  // zhipu | qwen
  "stream": true
}
```

**å“åº”:** Server-Sent Events (SSE)
```
data: {"type": "start", "timestamp": "2025-10-28T10:00:00Z"}

data: {"type": "content", "content": "AI å›å¤å†…å®¹ç‰‡æ®µ"}

data: {"type": "content", "content": "æ›´å¤šå†…å®¹"}

data: {"type": "end", "timestamp": "2025-10-28T10:00:05Z"}
```

#### POST /api/web/extract

**è¯·æ±‚ä½“:**
```json
{
  "url": "https://example.com",
  "mode": "text"  // text | markdown | json
}
```

**å“åº”:**
```json
{
  "url": "https://example.com",
  "title": "ç½‘é¡µæ ‡é¢˜",
  "content": "æå–çš„å†…å®¹",
  "metadata": {
    "description": "ç½‘é¡µæè¿°",
    "keywords": ["å…³é”®è¯1", "å…³é”®è¯2"]
  }
}
```

---

## å‰ç«¯å¼€å‘æŒ‡å—

### ç‹¬ç«‹æ¨¡å¼å®ç°

#### å¯¹è¯é¡µé¢ (chat.html)

**æ ¸å¿ƒåŠŸèƒ½:**
1. æ¶ˆæ¯åˆ—è¡¨å±•ç¤º
2. è¾“å…¥æ¡†å’Œå‘é€æŒ‰é’®
3. æµå¼å“åº”æ˜¾ç¤º
4. Markdown æ¸²æŸ“
5. ä»£ç é«˜äº®

**å…³é”®ä»£ç :**

```javascript
// frontend/standalone/js/chat.js

class ChatApp {
  constructor(sessionId) {
    this.sessionId = sessionId;
    this.apiBase = '/api';
  }

  async sendMessage(message) {
    // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ° UI
    this.addMessage('user', message);

    // åˆ›å»º AI æ¶ˆæ¯å ä½ç¬¦
    const aiMsgId = this.addMessage('assistant', '');

    try {
      const response = await fetch(`${this.apiBase}/chat/stream`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          session_id: this.sessionId,
          message: message,
          stream: true
        })
      });

      const reader = response.body.getReader();
      const decoder = new TextDecoder();
      let buffer = '';

      while (true) {
        const {done, value} = await reader.read();
        if (done) break;

        buffer += decoder.decode(value, {stream: true});
        const lines = buffer.split('\n');
        buffer = lines.pop();

        for (const line of lines) {
          if (line.startsWith('data: ')) {
            const data = JSON.parse(line.slice(6));
            if (data.type === 'content') {
              this.updateMessage(aiMsgId, data.content);
            }
          }
        }
      }
    } catch (error) {
      console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
      this.showError('å‘é€å¤±è´¥,è¯·é‡è¯•');
    }
  }

  addMessage(role, content) {
    // æ·»åŠ æ¶ˆæ¯åˆ° DOM
    const msgEl = document.createElement('div');
    msgEl.className = `message message-${role}`;
    msgEl.innerHTML = this.renderMarkdown(content);
    document.querySelector('.message-list').appendChild(msgEl);
    return msgEl.id;
  }

  updateMessage(id, content) {
    // æ›´æ–°æ¶ˆæ¯å†…å®¹
    const msgEl = document.getElementById(id);
    msgEl.innerHTML = this.renderMarkdown(content);
  }

  renderMarkdown(text) {
    // ä½¿ç”¨ markdown-it æ¸²æŸ“
    return window.markdownit().render(text);
  }
}
```

### åµŒå…¥æ¨¡å¼å®ç°

#### æ ¸å¿ƒè„šæœ¬ (popup.js)

**åŠŸèƒ½ç‰¹ç‚¹:**
1. å•æ–‡ä»¶å®ç°
2. Shadow DOM æ ·å¼éš”ç¦»
3. æœ€å°åŒ–ä¾èµ–
4. çµæ´»é…ç½®

**é›†æˆæ–¹å¼:**

```html
<!-- åœ¨ç›®æ ‡ç½‘ç«™ä¸­æ·»åŠ  -->
<script src="https://your-domain.com/popup.js"></script>
<script>
  PopupChat.init({
    apiKey: 'your-api-key',
    model: 'zhipu',
    position: 'right',  // right | left
    theme: 'light'      // light | dark
  });
</script>
```

**æ ¸å¿ƒä»£ç ç»“æ„:**

```javascript
// frontend/embedded/popup.js

(function() {
  'use strict';

  class PopupChat {
    constructor(config) {
      this.config = config;
      this.isOpen = false;
      this.init();
    }

    init() {
      // åˆ›å»º Shadow DOM
      this.container = document.createElement('div');
      this.container.id = 'popup-chat-container';
      document.body.appendChild(this.container);

      const shadow = this.container.attachShadow({mode: 'open'});
      
      // æ³¨å…¥æ ·å¼
      const style = document.createElement('style');
      style.textContent = this.getStyles();
      shadow.appendChild(style);

      // åˆ›å»º UI
      this.createUI(shadow);
      
      // ç»‘å®šäº‹ä»¶
      this.bindEvents();
    }

    createUI(shadow) {
      const html = `
        <div class="popup-chat">
          <button class="popup-trigger">ğŸ’¬</button>
          <div class="popup-panel" style="display: none;">
            <div class="popup-header">
              <h3>AI åŠ©æ‰‹</h3>
              <div class="popup-actions">
                <button class="btn-summarize" title="æ€»ç»“é¡µé¢">ğŸ“„</button>
                <button class="btn-screenshot" title="æˆªå›¾åˆ†æ">ğŸ“·</button>
                <button class="btn-close">âœ•</button>
              </div>
            </div>
            <div class="popup-body">
              <div class="message-list"></div>
            </div>
            <div class="popup-footer">
              <textarea placeholder="è¾“å…¥æ¶ˆæ¯..." rows="2"></textarea>
              <button class="btn-send">å‘é€</button>
            </div>
          </div>
        </div>
      `;
      
      const wrapper = document.createElement('div');
      wrapper.innerHTML = html;
      shadow.appendChild(wrapper);
    }

    async summarizePage() {
      // æå–å½“å‰é¡µé¢å†…å®¹
      const content = this.extractPageContent();
      
      // è°ƒç”¨ API æ€»ç»“
      const summary = await this.callAPI('/api/web/summarize', {
        content: content,
        url: window.location.href
      });
      
      // æ˜¾ç¤ºç»“æœ
      this.addMessage('assistant', summary);
    }

    extractPageContent() {
      // æå–é¡µé¢ä¸»è¦å†…å®¹
      const title = document.title;
      const main = document.querySelector('main, article, .content, #content');
      const text = main ? main.innerText : document.body.innerText;
      
      return {
        title: title,
        text: text.slice(0, 5000),  // é™åˆ¶é•¿åº¦
        url: window.location.href
      };
    }

    async captureScreenshot() {
      // ä½¿ç”¨ html2canvas æˆ– æµè§ˆå™¨ API æˆªå›¾
      // è¿™é‡Œç®€åŒ–å¤„ç†
      alert('æˆªå›¾åŠŸèƒ½å¼€å‘ä¸­');
    }

    getStyles() {
      return `
        .popup-chat {
          position: fixed;
          right: 20px;
          bottom: 20px;
          z-index: 999999;
        }
        
        .popup-trigger {
          width: 60px;
          height: 60px;
          border-radius: 50%;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          border: none;
          color: white;
          font-size: 24px;
          cursor: pointer;
          box-shadow: 0 4px 12px rgba(0,0,0,0.15);
          transition: transform 0.2s;
        }
        
        .popup-trigger:hover {
          transform: scale(1.1);
        }
        
        .popup-panel {
          position: absolute;
          right: 0;
          bottom: 80px;
          width: 400px;
          height: 600px;
          background: white;
          border-radius: 12px;
          box-shadow: 0 8px 32px rgba(0,0,0,0.2);
          display: flex;
          flex-direction: column;
        }
        
        .popup-header {
          padding: 16px;
          border-bottom: 1px solid #e5e7eb;
          display: flex;
          justify-content: space-between;
          align-items: center;
        }
        
        .popup-body {
          flex: 1;
          overflow-y: auto;
          padding: 16px;
        }
        
        .popup-footer {
          padding: 16px;
          border-top: 1px solid #e5e7eb;
          display: flex;
          gap: 8px;
        }
        
        .popup-footer textarea {
          flex: 1;
          border: 1px solid #e5e7eb;
          border-radius: 8px;
          padding: 8px;
          resize: none;
        }
        
        .btn-send {
          padding: 8px 16px;
          background: #667eea;
          color: white;
          border: none;
          border-radius: 8px;
          cursor: pointer;
        }
      `;
    }
  }

  // å…¨å±€æš´éœ²
  window.PopupChat = {
    init: (config) => new PopupChat(config)
  };
})();
```

---

## åç«¯å¼€å‘æŒ‡å—

### FastAPI ä¸»åº”ç”¨

```python
# backend/main.py

from pathlib import Path
from contextlib import asynccontextmanager

import fastapi
from fastapi import Request
from fastapi.responses import FileResponse
from fastapi.middleware.cors import CORSMiddleware
from fastapi.staticfiles import StaticFiles

from .database import Database
from .routers import chat, history, config, web, draw

THIS_DIR = Path(__file__).parent
FRONTEND_DIR = THIS_DIR.parent / 'frontend'
DATA_DIR = THIS_DIR.parent / 'data'
DB_FILE = DATA_DIR / 'chat.db'

# ç¡®ä¿æ•°æ®ç›®å½•å­˜åœ¨
DATA_DIR.mkdir(exist_ok=True)


@asynccontextmanager
async def lifespan(_app: fastapi.FastAPI):
    """åº”ç”¨ç”Ÿå‘½å‘¨æœŸç®¡ç†"""
    async with Database.connect(DB_FILE) as db:
        yield {'db': db}


app = fastapi.FastAPI(
    title="PopupChatKit API",
    description="AI å¯¹è¯ä¸ç½‘é¡µåˆ†ææœåŠ¡",
    version="1.0.0",
    lifespan=lifespan
)

# CORS é…ç½®
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],  # ç”Ÿäº§ç¯å¢ƒåº”é™åˆ¶å…·ä½“åŸŸå
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# æ³¨å†Œè·¯ç”±
app.include_router(chat.router, prefix="/api/chat", tags=["å¯¹è¯"])
app.include_router(history.router, prefix="/api/sessions", tags=["ä¼šè¯"])
app.include_router(config.router, prefix="/api/config", tags=["é…ç½®"])
app.include_router(web.router, prefix="/api/web", tags=["ç½‘é¡µåˆ†æ"])
app.include_router(draw.router, prefix="/api/draw", tags=["ç»˜ç”»"])

# é™æ€æ–‡ä»¶æœåŠ¡
app.mount("/static", StaticFiles(directory=FRONTEND_DIR), name="static")


@app.get("/")
async def root():
    """è¿”å›ç‹¬ç«‹æ¨¡å¼é¦–é¡µ"""
    return FileResponse(FRONTEND_DIR / 'standalone' / 'index.html')


@app.get("/popup.js")
async def popup_script():
    """è¿”å›åµŒå…¥å¼è„šæœ¬"""
    return FileResponse(
        FRONTEND_DIR / 'embedded' / 'popup.js',
        media_type='application/javascript'
    )


async def get_db(request: Request) -> Database:
    """ä¾èµ–æ³¨å…¥: è·å–æ•°æ®åº“è¿æ¥"""
    return request.state.db


if __name__ == '__main__':
    import uvicorn
    uvicorn.run(
        'backend.main:app',
        host='0.0.0.0',
        port=8000,
        reload=True
    )
```

### AI Agent é…ç½®

```python
# backend/agents.py

from pydantic_ai import Agent
from typing import Literal

# æ™ºè°± AI Agent
zhipu_agent = Agent(
    'zhipu:glm-4',  # æ¨¡å‹åç§°
    system_prompt="""ä½ æ˜¯ä¸€ä¸ªå‹å¥½ã€ä¸“ä¸šçš„ AI åŠ©æ‰‹ã€‚
    
ä½ çš„èŒè´£:
1. å‡†ç¡®ç†è§£ç”¨æˆ·æ„å›¾,æä¾›æœ‰ä»·å€¼çš„å›ç­”
2. ä»¥ç®€æ´æ¸…æ™°çš„æ–¹å¼è¡¨è¾¾,å¿…è¦æ—¶ä½¿ç”¨ Markdown æ ¼å¼
3. å¯¹äºä»£ç ç›¸å…³é—®é¢˜,æä¾›å®Œæ•´å¯è¿è¡Œçš„ç¤ºä¾‹
4. é‡åˆ°ä¸ç¡®å®šçš„ä¿¡æ¯,è¯šå®å‘ŠçŸ¥è€Œéè‡†æµ‹

ä½ çš„ç‰¹ç‚¹:
- å‹å¥½ä½†ä¸è¿‡åº¦çƒ­æƒ…
- ä¸“ä¸šä½†ä¸ç”Ÿç¡¬
- ç®€æ´ä½†ä¸çœç•¥å…³é”®ä¿¡æ¯
"""
)

# é€šä¹‰åƒé—® Agent
qwen_agent = Agent(
    'qwen:qwen-turbo',
    system_prompt="""ä½ æ˜¯ä¸€ä¸ªå‹å¥½ã€ä¸“ä¸šçš„ AI åŠ©æ‰‹ã€‚
    
ä½ çš„èŒè´£:
1. å‡†ç¡®ç†è§£ç”¨æˆ·æ„å›¾,æä¾›æœ‰ä»·å€¼çš„å›ç­”
2. ä»¥ç®€æ´æ¸…æ™°çš„æ–¹å¼è¡¨è¾¾,å¿…è¦æ—¶ä½¿ç”¨ Markdown æ ¼å¼
3. å¯¹äºä»£ç ç›¸å…³é—®é¢˜,æä¾›å®Œæ•´å¯è¿è¡Œçš„ç¤ºä¾‹
4. é‡åˆ°ä¸ç¡®å®šçš„ä¿¡æ¯,è¯šå®å‘ŠçŸ¥è€Œéè‡†æµ‹

ä½ çš„ç‰¹ç‚¹:
- å‹å¥½ä½†ä¸è¿‡åº¦çƒ­æƒ…
- ä¸“ä¸šä½†ä¸ç”Ÿç¡¬
- ç®€æ´ä½†ä¸çœç•¥å…³é”®ä¿¡æ¯
"""
)


def get_agent(model: Literal['zhipu', 'qwen'] = 'zhipu') -> Agent:
    """æ ¹æ®æ¨¡å‹åç§°è·å– Agent"""
    if model == 'qwen':
        return qwen_agent
    return zhipu_agent
```

### å¯¹è¯è·¯ç”±å®ç°

```python
# backend/routers/chat.py

import json
from datetime import datetime, timezone
from typing import Annotated

from fastapi import APIRouter, Depends, Form
from fastapi.responses import StreamingResponse

from ..database import Database
from ..agents import get_agent
from ..models import ChatMessage, ChatRequest

router = APIRouter()


async def get_db() -> Database:
    """è·å–æ•°æ®åº“è¿æ¥ (ç®€åŒ–ç‰ˆ,å®é™…ä» request.state è·å–)"""
    pass  # å®é™…å®ç°è§ main.py


@router.post('/stream')
async def chat_stream(
    request: ChatRequest,
    database: Database = Depends(get_db)
) -> StreamingResponse:
    """æµå¼å¯¹è¯æ¥å£"""
    
    async def stream_messages():
        # å‘é€ç”¨æˆ·æ¶ˆæ¯
        yield json.dumps({
            'type': 'start',
            'timestamp': datetime.now(tz=timezone.utc).isoformat()
        }).encode('utf-8') + b'\n'
        
        # è·å–å†å²æ¶ˆæ¯
        messages = await database.get_messages(request.session_id)
        
        # é€‰æ‹© Agent
        agent = get_agent(request.model)
        
        # è¿è¡Œ Agent
        async with agent.run_stream(
            request.message,
            message_history=messages
        ) as result:
            async for text in result.stream_output(debounce_by=0.01):
                yield json.dumps({
                    'type': 'content',
                    'content': text
                }).encode('utf-8') + b'\n'
        
        # ä¿å­˜æ–°æ¶ˆæ¯
        await database.add_messages(
            request.session_id,
            result.new_messages_json()
        )
        
        # æ›´æ–°ä¼šè¯æ—¶é—´
        await database.update_session(request.session_id)
        
        # å‘é€ç»“æŸæ ‡è®°
        yield json.dumps({
            'type': 'end',
            'timestamp': datetime.now(tz=timezone.utc).isoformat()
        }).encode('utf-8') + b'\n'
    
    return StreamingResponse(
        stream_messages(),
        media_type='text/plain'
    )


@router.get('/history/{session_id}')
async def get_history(
    session_id: str,
    database: Database = Depends(get_db)
):
    """è·å–å¯¹è¯å†å²"""
    messages = await database.get_messages(session_id)
    return {'session_id': session_id, 'messages': messages}
```

---

## éƒ¨ç½²æŒ‡å—

### å¼€å‘ç¯å¢ƒ

```bash
# 1. å…‹éš†é¡¹ç›®
git clone https://github.com/your-name/PopupChatKit.git
cd PopupChatKit

# 2. å®‰è£… uv (å¦‚æœæœªå®‰è£…)
curl -LsSf https://astral.sh/uv/install.sh | sh

# 3. å®‰è£…ä¾èµ–
cd backend
uv sync

# 4. é…ç½®ç¯å¢ƒå˜é‡
cp .env.example .env
# ç¼–è¾‘ .env æ–‡ä»¶,å¡«å…¥ API Keys

# 5. å¯åŠ¨å¼€å‘æœåŠ¡å™¨
uv run python -m backend.main

# 6. è®¿é—®
# http://localhost:8000
```

### ç”Ÿäº§ç¯å¢ƒ

```bash
# ä½¿ç”¨ Docker éƒ¨ç½²
docker build -t popupchatkit .
docker run -d -p 8000:8000 \
  -v $(pwd)/data:/app/data \
  -e ZHIPU_API_KEY=your_key \
  -e QWEN_API_KEY=your_key \
  popupchatkit
```

### Dockerfile

```dockerfile
FROM python:3.11-slim

WORKDIR /app

# å®‰è£… uv
RUN pip install uv

# å¤åˆ¶é¡¹ç›®æ–‡ä»¶
COPY backend/ ./backend/
COPY frontend/ ./frontend/
COPY pyproject.toml .

# å®‰è£…ä¾èµ–
RUN uv sync --no-dev

# æš´éœ²ç«¯å£
EXPOSE 8000

# å¯åŠ¨åº”ç”¨
CMD ["uv", "run", "python", "-m", "backend.main"]
```

---

## æµ‹è¯•ç­–ç•¥

### å•å…ƒæµ‹è¯•

```python
# tests/test_database.py

import pytest
from backend.database import Database

@pytest.mark.asyncio
async def test_add_and_get_messages():
    async with Database.connect(':memory:') as db:
        session_id = 'test-session'
        await db.create_session(session_id, 'æµ‹è¯•ä¼šè¯')
        
        # æ·»åŠ æ¶ˆæ¯
        messages = [...]  # ModelMessage åˆ—è¡¨
        await db.add_messages(session_id, json.dumps(messages).encode())
        
        # è·å–æ¶ˆæ¯
        retrieved = await db.get_messages(session_id)
        assert len(retrieved) == len(messages)
```

### é›†æˆæµ‹è¯•

```python
# tests/test_api.py

from fastapi.testclient import TestClient
from backend.main import app

client = TestClient(app)

def test_chat_stream():
    response = client.post(
        '/api/chat/stream',
        json={
            'session_id': 'test',
            'message': 'ä½ å¥½',
            'model': 'zhipu',
            'stream': True
        }
    )
    assert response.status_code == 200
```

---

## æ€§èƒ½ä¼˜åŒ–

### 1. æ•°æ®åº“ä¼˜åŒ–
- ä½¿ç”¨ç´¢å¼•åŠ é€ŸæŸ¥è¯¢
- å®šæœŸæ¸…ç†è¿‡æœŸæ•°æ®
- è€ƒè™‘ä½¿ç”¨è¿æ¥æ± 

### 2. ç¼“å­˜ç­–ç•¥
- é™æ€èµ„æºä½¿ç”¨ CDN
- API å“åº”ä½¿ç”¨ Redis ç¼“å­˜
- ç½‘é¡µæå–ç»“æœç¼“å­˜

### 3. å‰ç«¯ä¼˜åŒ–
- ä»£ç åˆ†å‰²å’Œæ‡’åŠ è½½
- å›¾ç‰‡æ‡’åŠ è½½å’Œå‹ç¼©
- ä½¿ç”¨ Web Workers å¤„ç†å¤§æ•°æ®

---

## å®‰å…¨è€ƒè™‘

### 1. API Key å®‰å…¨
- åç«¯å­˜å‚¨æ—¶åŠ å¯†
- ä¼ è¾“ä½¿ç”¨ HTTPS
- æ”¯æŒç¯å¢ƒå˜é‡é…ç½®

### 2. XSS é˜²æŠ¤
- ç”¨æˆ·è¾“å…¥ä¸¥æ ¼è¿‡æ»¤
- Markdown æ¸²æŸ“ä½¿ç”¨ç™½åå•
- CSP ç­–ç•¥é…ç½®

### 3. CSRF é˜²æŠ¤
- ä½¿ç”¨ Token éªŒè¯
- æ£€æŸ¥ Referer å¤´
- SameSite Cookie

### 4. é€Ÿç‡é™åˆ¶
- API è°ƒç”¨é¢‘ç‡é™åˆ¶
- IP é»‘åå•æœºåˆ¶
- ç”¨é‡ç›‘æ§å‘Šè­¦

---

## å¸¸è§é—®é¢˜

### Q1: å¦‚ä½•åˆ‡æ¢ LLM æ¨¡å‹?
A: åœ¨é…ç½®é¡µé¢æˆ– API è¯·æ±‚ä¸­æŒ‡å®š `model` å‚æ•°ä¸º `zhipu` æˆ– `qwen`ã€‚

### Q2: åµŒå…¥æ¨¡å¼å¦‚ä½•é¿å…æ ·å¼å†²çª?
A: ä½¿ç”¨ Shadow DOM å®ç°æ ·å¼éš”ç¦»,ç¡®ä¿ä¸å½±å“å®¿ä¸»é¡µé¢ã€‚

### Q3: æ•°æ®åº“æ–‡ä»¶å­˜å‚¨åœ¨å“ªé‡Œ?
A: é»˜è®¤å­˜å‚¨åœ¨ `data/chat.db`,å¯é€šè¿‡ç¯å¢ƒå˜é‡ `DB_PATH` é…ç½®ã€‚

### Q4: å¦‚ä½•å¤‡ä»½å¯¹è¯å†å²?
A: ç›´æ¥å¤‡ä»½ `data/chat.db` æ–‡ä»¶,æˆ–ä½¿ç”¨ API å¯¼å‡ºä¸º JSONã€‚

---

## å‚è€ƒèµ„æ–™

- [FastAPI å®˜æ–¹æ–‡æ¡£](https://fastapi.tiangolo.com/)
- [pydantic-ai æ–‡æ¡£](https://ai.pydantic.dev/)
- [æ™ºè°± AI API æ–‡æ¡£](https://open.bigmodel.cn/dev/api)
- [é€šä¹‰åƒé—® API æ–‡æ¡£](https://help.aliyun.com/zh/dashscope/)
- [MDN Web Docs](https://developer.mozilla.org/)

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0.0  
**æœ€åæ›´æ–°**: 2025-10-28  
**ç»´æŠ¤è€…**: Colin
